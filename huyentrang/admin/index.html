<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <title>Qu·∫£n l√Ω RSVP</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      .hidden {
        display: none;
      }
      table {
        border-collapse: collapse;
        width: 100%;
        margin-top: 20px;
      }
      th,
      td {
        border: 1px solid #ccc;
        padding: 8px;
      }
      th {
        background-color: #f2f2f2;
      }

      .media-wrapper {
        display: flex;
        gap: 10px;
        align-items: center;
      }

      .media-wrapper img {
        width: 300px;
        height: 100px;
        object-fit: cover;
        border-radius: 6px;
      }

      #rsvpChart {
        max-width: 400px;
        max-height: 300px;
        width: 100%;
        height: auto;
        margin: 0 auto; /* cƒÉn gi·ªØa */
        display: block;
      }
    </style>

    <style>
      .popup {
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: rgba(0, 0, 0, 0.6);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 999;
      }

      .popup-content {
        background: white;
        padding: 10px;
        border-radius: 10px;
        position: relative;
        width: 90%;
        max-width: 800px;
        height: 90%;
      }

      .popup iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 6px;
      }

      .close-btn {
        position: absolute;
        top: 5px;
        right: 15px;
        font-size: 24px;
        cursor: pointer;
      }
      .hidden {
        display: none;
      }
    </style>
  </head>
  <body>
    <h2>üë• Danh s√°ch</h2>
    <div style="text-align: right; margin-top: 10px">
      <button onclick="logout()">üö™ ƒêƒÉng xu·∫•t</button>
    </div>
    <!-- üß© Th√™m √¥ t√¨m ki·∫øm -->
    <div style="text-align: right; margin-top: 10px">
      <input
        type="text"
        id="searchInput"
        placeholder="üîç T√¨m ki·∫øm theo t√™n kh√°ch m·ªùi..."
        style="padding: 5px; width: 300px"
      />
    </div>
    <button onclick="exportToExcel()">üì• Xu·∫•t Excel</button>

    <table>
      <thead>
        <tr>
          <th style="width: 25px">STT</th>
          <th style="width: 275px">T√™n kh√°ch m·ªùi</th>
          <th style="width: 80px">Tr·∫°ng th√°i</th>
          <th style="width: 275px">Message</th>
        </tr>
      </thead>
      <tbody id="rsvpTableBody"></tbody>
    </table>

    <div style="width: 100%; max-width: 400px; height: 300px; margin: auto">
      <canvas id="rsvpChart"></canvas>
    </div>

    <script src="/huyentrang/admin/config.js"></script>
    <script>
      const { createClient } = supabase;
      const supabaseClient = createClient(
        CONFIG.SUPABASE_URL,
        CONFIG.SUPABASE_KEY
      );

      // N·∫øu ch∆∞a ƒëƒÉng nh·∫≠p th√¨ quay v·ªÅ login
      if (localStorage.getItem("loggedInAdmin") !== "true") {
        window.location.href = "login.html";
      }

      function logout() {
        localStorage.removeItem("loggedInAdmin");
        window.location.href = "login.html";
      }
      let allThemes = [];

      async function loadData() {
        const { data, error } = await supabaseClient
          .from("rsvp_messages")
          .select("*")
          .order("id", { ascending: false });

        if (error) {
          document.getElementById(
            "rsvpTableBody"
          ).innerHTML = `<tr><td colspan="4">‚ö†Ô∏è L·ªói t·∫£i d·ªØ li·ªáu</td></tr>`;
          return;
        }

        allThemes = data;
        renderData(allThemes);
      }

      function renderData(data) {
        const tbody = document.getElementById("rsvpTableBody");
        tbody.innerHTML = "";

        data.forEach((item, index) => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
        <td>${index + 1}</td>
        <td>${item.name}</td>
        <td>${item.confirmation == "1" ? "C√≥ tham d·ª±" : "Kh√¥ng tham d·ª±"}</td>
        <td>${item.message}</td>

      `;
          tbody.appendChild(tr);
        });
      }

      // üîç T√¨m ki·∫øm theo t√™n thi·ªáp
      document.getElementById("searchInput").addEventListener("input", (e) => {
        const keyword = e.target.value.toLowerCase();
        const filtered = allThemes.filter((item) =>
          item.name.toLowerCase().includes(keyword)
        );
        renderData(filtered);
      });

      async function deleteEntry(id, name) {
        if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën xo√° " + name + " kh√¥ng ?")) return;

        const { error } = await supabaseClient
          .from("rsvp_messages")
          .delete()
          .eq("id", id);

        if (error) return alert("‚ùå Xo√° th·∫•t b·∫°i: " + error.message);
        loadData();
      }

      loadData();
    </script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

    <script>
      const supabase = window.supabase.createClient(
        CONFIG.SUPABASE_URL,
        CONFIG.SUPABASE_KEY
      );

      async function loadDataAndChart() {
        const { data, error } = await supabase
          .from("rsvp_messages")
          .select("*");

        if (error) {
          console.error("L·ªói khi load d·ªØ li·ªáu:", error);
          return;
        }

        const countYes = data.filter((item) => item.confirmation == "1").length;
        const countNo = data.filter((item) => item.confirmation == "0").length;

        const ctx = document.getElementById("rsvpChart").getContext("2d");
        new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["C√≥ tham d·ª±", "Kh√¥ng tham d·ª±"],
            datasets: [
              {
                label: "S·ªë l∆∞·ª£ng",
                data: [countYes, countNo],
                backgroundColor: ["#4caf50", "#f44336"],
              },
            ],
          },
          options: {
            responsive: true,
          },
        });
      }

      loadDataAndChart();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
      async function exportToExcel() {
        const { data, error } = await supabase
          .from("rsvp_messages")
          .select("*");

        if (error) {
          alert("L·ªói l·∫•y d·ªØ li·ªáu");
          console.error(error);
          return;
        }

        // Chuy·ªÉn confirmation sang vƒÉn b·∫£n
        const formattedData = data.map((item, index) => ({
          STT: index + 1,
          "T√™n kh√°ch m·ªùi": item.name,
          "Tr·∫°ng th√°i": item.confirmation == 1 ? "C√≥ tham d·ª±" : "Kh√¥ng tham d·ª±",
          "L·ªùi nh·∫Øn": item.message,
        }));

        // T·∫°o sheet v√† export
        const worksheet = XLSX.utils.json_to_sheet(formattedData);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "RSVP");

        XLSX.writeFile(workbook, "danh_sach_rsvp.xlsx");
      }
    </script>
  </body>
</html>
